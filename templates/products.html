{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Products</h3>
  <div>
    <button class="btn btn-sm btn-secondary" id="import-products-btn">Import CSV</button>
    <a class="btn btn-sm btn-info" href="/products/export">Export CSV</a>
    <button class="btn btn-sm btn-primary" id="open-add-product">+ Add</button>
  </div>
</div>

<div id="product-form-card" class="card p-3 mb-3 d-none">
  <form id="product-form">
    <input type="hidden" name="id" value="">
    <div class="row g-2">
      <div class="col-md-6"><input name="name" class="form-control" placeholder="Name" required></div>
      <div class="col-md-3"><input name="price" type="number" step="0.01" class="form-control" placeholder="Price" required></div>
      <div class="col-md-3"><button class="btn btn-success w-100">Save</button></div>
    </div>
  </form>
</div>

<div class="card p-3">
  <table class="table" id="products-table">
    <thead><tr><th>Name</th><th>Price</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- hidden file form for import -->
<form id="import-products-form" method="post" action="/products/import" enctype="multipart/form-data" class="d-none">
  <input type="file" name="file" id="import-products-file" accept=".csv">
</form>

<script>
function loadProducts(){
  $.getJSON("/api/products", function(data){
    const tbody = $("#products-table tbody").empty();
    data.products.forEach(p=>{
      tbody.append(`<tr data-id="${p.id}"><td>${p.name}</td><td>${p.price}</td>
        <td>
          <button class="btn btn-sm btn-warning edit">Edit</button>
          <button class="btn btn-sm btn-danger del">Delete</button>
        </td></tr>`);
    });
  });
}

$("#open-add-product").click(()=>{ $("#product-form-card").removeClass("d-none"); $("#product-form")[0].reset(); $("#product-form input[name=id]").val(""); });
$("#product-form").submit(function(e){
  e.preventDefault();
  const id = $(this).find("input[name=id]").val();
  const data = $(this).serialize();
  if(id){
    $.ajax({url:`/api/products/${id}`, type:"PUT", data:data, success:loadProducts});
  } else {
    $.post("/api/products", data, loadProducts);
  }
  $("#product-form-card").addClass("d-none");
});
$("#products-table").on("click",".edit", function(){
  const tr = $(this).closest("tr"); const id = tr.data("id");
  const name = tr.find("td:eq(0)").text(); const price = tr.find("td:eq(1)").text();
  $("#product-form-card").removeClass("d-none");
  $("#product-form input[name=id]").val(id);
  $("#product-form input[name=name]").val(name);
  $("#product-form input[name=price]").val(price);
});
$("#products-table").on("click",".del", function(){
  if(!confirm("Delete product?")) return;
  const id = $(this).closest("tr").data("id");
  $.ajax({url:`/api/products/${id}`, type:"DELETE", success:loadProducts});
});
$("#import-products-btn").click(()=>$("#import-products-file").click());
$("#import-products-file").change(function(){ $("#import-products-form").submit(); });
loadProducts();
</script>
{% endblock %}
